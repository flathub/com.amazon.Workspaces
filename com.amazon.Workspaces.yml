app-id: com.amazon.Workspaces
runtime: org.gnome.Platform
runtime-version: '47'
sdk: org.gnome.Sdk
command: workspacesclient

finish-args:
  - --socket=fallback-x11
  - --socket=wayland
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network
  - --own-name=com.amazon.workspacesclient

cleanup:
  - '*.a'
  - '*.la'
  - /include
  - /lib/icu
  - /lib/cmake
  - /lib/pkgconfig
  - /share/doc
  - /share/gir-1.0
  - /share/icu
  - /share/man
  - /share/vala

modules:

  - name: dconf
    buildsystem: meson
    config-opts:
      - -Dbash_completion=false
      - -Dman=false
      - -Dvapi=false
    cleanup:
      - /etc
      - /include
      - ca.desrt.dconf.service
      - dconf.service
      - dconf-service
      - '*.pc'
    sources:
      - type: archive
        url: https://download.gnome.org/sources/dconf/0.40/dconf-0.40.0.tar.xz
        sha256: cf7f22a4c9200421d8d3325c5c1b8b93a36843650c9f95d6451e20f0bcb24533
      - type: patch
        path: patches/dconf/no-systemd.patch

  - name: jbig
    no-autogen: true
    no-make-install: true
    make-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: archive
        url: https://www.cl.cam.ac.uk/~mgk25/jbigkit/download/jbigkit-2.1.tar.gz
        sha256: de7106b6bfaf495d6865c7dd7ac6ca1381bd12e0d81405ea81e7f2167263d932
      - type: patch
        path: patches/libjbig/jbigkit-2.1-shared.diff
    post-install:
      - mkdir -p ${FLATPAK_DEST}/lib
      - cp -a libjbig/.libs/*.so.* ${FLATPAK_DEST}/lib

  - name: libdeflate
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DLIBDEFLATE_BUILD_STATIC_LIB=OFF
      - -DLIBDEFLATE_BUILD_TESTS=OFF
    sources:
      - type: archive
        url: https://github.com/ebiggers/libdeflate/releases/download/v1.22/libdeflate-1.22.tar.gz
        sha256: 7834d9adbc9a809e0fb0d7b486060a9ae5f7819eb7f55bb8c22b10d7b3bed8da

  - name: pcsclite
    config-opts:
      - --sbindir=/app/bin
      - --disable-libsystemd
      - --disable-libudev
      - --disable-polkit
      - --disable-usb
      - --with-systemdsystemunitdir=no
    sources:
      - type: git
        url: https://github.com/LudovicRousseau/PCSC
        tag: 2.2.3
        commit: 33a028a9750eb33fb2fb7463a9924852b474d633
    cleanup:
      - /bin

  - name: icu70
    buildsystem: simple
    build-commands:
      - cd source && ./configure --prefix=${FLATPAK_DEST} --sbindir=${FLATPAK_DEST}/bin
        --disable-tests --disable-samples && make -j $FLATPAK_BUILDER_N_JOBS install
    sources:
      - type: archive
        url: https://github.com/unicode-org/icu/releases/download/release-70-1/icu4c-70_1-src.tgz
        sha256: 8d205428c17bf13bb535300669ed28b338a157b1c01ae66d31d0d3e2d47c3fd5
    cleanup:
      - /bin

  - name: workspacesclient
    buildsystem: simple
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/bin
      - install apply_extra ${FLATPAK_DEST}/bin
      - install run.sh ${FLATPAK_DEST}/bin
      - ln -s ${FLATPAK_DEST}/bin/run.sh ${FLATPAK_DEST}/bin/workspacesclient
      - install -Dm644 -t ${FLATPAK_DEST}/share/metainfo/ ${FLATPAK_ID}.metainfo.xml
      - install -Dm644 -t ${FLATPAK_DEST}/share/applications/ ${FLATPAK_ID}.desktop
      - install -Dm644 -t ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/ ${FLATPAK_ID}.svg
    sources:
      - type: script
        dest-filename: apply_extra
        commands:
          - bsdtar -Oxf workspacesclient.deb data.tar.xz | bsdtar -xf -
          - rm -rf usr/share/applications usr/share/icons usr/share/doc usr/share/icons workspacesclient.deb
          - ln -sf /app/lib/gio/modules/libdconfsettings.so usr/lib/x86_64-linux-gnu/workspacesclient/dcv/gio/modules/
          - sed -i -e "s/basedir=\/usr/basedir=\/app\/extra\/usr/g" -e "/LD_LIBRARY_PATH/d" -e "/XDG_DATA_DIRS/d" usr/lib/x86_64-linux-gnu/workspacesclient/dcv/dcvclient
          - GSETTINGS_SCHEMA_DIR="./usr/share/glib-2.0/schemas:${GSETTINGS_SCHEMA_DIR}" glib-compile-schemas usr/share/glib-2.0/schemas
          - usr/lib/x86_64-linux-gnu/workspacesclient/dcv/gdk-pixbuf-query-loaders usr/lib/x86_64-linux-gnu/workspacesclient/dcv/gdk-pixbuf-2.0/2.10.0/loaders/*.so  > usr/lib/x86_64-linux-gnu/workspacesclient/dcv/gdk-pixbuf-2.0/2.10.0/loaders.cache
          - usr/lib/x86_64-linux-gnu/workspacesclient/dcv/gtk-query-immodules-3.0 usr/lib/x86_64-linux-gnu/workspacesclient/dcv/gtk-3.0/3.0.0/immodules/*.so > usr/lib/x86_64-linux-gnu/workspacesclient/dcv/gtk-3.0/3.0.0/immodules.cache

      - type: script
        dest-filename: run.sh
        commands:
          - set -e
          - export LD_LIBRARY_PATH="/app/lib:/usr/lib/x86_64-linux-gnu:/app/extra/usr/lib/x86_64-linux-gnu/workspacesclient/dcv"
          - export PATH="/app/extra/usr/lib/x86_64-linux-gnu/workspacesclient/dcv:${PATH}"
          - export XDG_DATA_DIRS="/app/extra/usr/share:${XDG_DATA_DIRS}"
          - export GTK_IM_MODULE_FILE="/app/extra/usr/lib/x86_64-linux-gnu/workspacesclient/dcv/gtk-3.0/3.0.0/immodules.cache"
          - export GDK_PIXBUF_MODULE_FILE="/app/extra/usr/lib/x86_64-linux-gnu/workspacesclient/dcv/gdk-pixbuf-2.0/2.10.0/loaders.cache"
          - export TMPDIR=$XDG_CACHE_HOME/tmp
          - exec /app/extra/usr/bin/workspacesclient "$@"

      - type: file
        path: com.amazon.Workspaces.metainfo.xml
      - type: file
        path: com.amazon.Workspaces.svg
      - type: file
        path: com.amazon.Workspaces.desktop

      - type: extra-data
        filename: workspacesclient.deb
        only-arches: [x86_64]
        url: https://d3nt0h4h6pmmc4.cloudfront.net/new_workspacesclient_jammy_amd64.deb
        sha256: cdff9d392d70ca5850301ac86987338a8a83cb56e660fb6f0e5c2a74adfd6db9
        size: 69140252
