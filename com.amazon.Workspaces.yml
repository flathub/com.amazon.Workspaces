app-id: com.amazon.Workspaces
runtime: org.gnome.Platform
runtime-version: '42'
sdk: org.gnome.Sdk
command: workspacesclient
tags:
  - proprietary

finish-args:
  - --socket=x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network

cleanup:
  - '*.a'
  - '*.la'
  - /include
  - /lib/icu
  - /lib/pkgconfig
  - /share/doc
  - /share/gir-1.0
  - /share/icu
  - /share/man

modules:

  - 'shared-modules/libusb/libusb.json'

  - name: hiredis0.14
    buildsystem: simple
    build-commands:
      - make PREFIX=${FLATPAK_DEST} install

    sources:
      - type: git
        url: https://github.com/redis/hiredis.git
        tag: v0.14.1
        commit: f9717aed445547c8ab11a3a4117f648c06e62b56

  - name: icu63
    buildsystem: simple
    build-commands:
      - cd source && ./configure --prefix=${FLATPAK_DEST} --sbindir=${FLATPAK_DEST}/bin --disable-tests --disable-samples && make -j $FLATPAK_BUILDER_N_JOBS install

    sources:
      - type: archive
        url: https://github.com/unicode-org/icu/releases/download/release-63-2/icu4c-63_2-src.tgz
        sha256: 4671e985b5c11252bff3c2374ab84fd73c609f2603bb6eb23b8b154c69ea4215
    cleanup:
      - /bin

  - name: graphicsmagick
    builddir: true
    config-opts:
      - --enable-shared
      - --enable-quantum-library-names
      - --with-quantum-depth=16
      - --with-magick_plus_plus
      - --with-modules
      - --with-threads

    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/graphicsmagick/graphicsmagick/1.3.40/GraphicsMagick-1.3.40.tar.xz
        sha256: 97dc1a9d4e89c77b25a3b24505e7ff1653b88f9bfe31f189ce10804b8efa7746
    cleanup:
      - /bin/GraphicsMagick*config
      - /bin/gm

  - name: workspacesclient
    buildsystem: simple
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/bin ${FLATPAK_DEST}/lib
      - install apply_extra ${FLATPAK_DEST}/bin
      - install -Dm644 -t ${FLATPAK_DEST}/share/metainfo/ ${FLATPAK_ID}.metainfo.xml
      - install -Dm644 -t ${FLATPAK_DEST}/share/applications/ ${FLATPAK_ID}.desktop
      - install -Dm644 -t ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/ ${FLATPAK_ID}.svg
      - cp /usr/bin/ar ${FLATPAK_DEST}/bin
      - ARCH_TRIPLE=$(gcc --print-multiarch) && cp /usr/lib/${ARCH_TRIPLE}/libbfd-*.so ${FLATPAK_DEST}/lib
      - ln -s ${FLATPAK_DEST}/extra/bin/workspacesclient ${FLATPAK_DEST}/bin/workspacesclient

    sources:
      - type: script
        dest-filename: apply_extra
        commands:
          - ar x 'workspacesclient.deb' data.tar.xz
          - tar xf data.tar.xz ./usr ./opt
          - rm -f data.tar.xz
          - mv opt/workspacesclient ./bin
          - rm -rf usr opt

      - type: file
        path: com.amazon.Workspaces.metainfo.xml
      - type: file
        path: com.amazon.Workspaces.svg
      - type: file
        path: com.amazon.Workspaces.desktop

      - type: extra-data
        filename: workspacesclient.deb
        only-arches: [x86_64]
        url: https://d3nt0h4h6pmmc4.cloudfront.net/ubuntu/dists/focal/main/binary-amd64/workspacesclient_4.6.0.4187_amd64.deb
        sha256: 03e6fbf5ec21e210487fc8e02b420d20b164b53a914693a05d11f4146ce257a7
        size: 28598808
        x-checker-data:
          type: debian-repo
          package-name: workspacesclient
          root: https://d3nt0h4h6pmmc4.cloudfront.net/ubuntu
          dist: focal
          component: main
